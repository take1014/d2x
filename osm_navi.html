<!DOCTYPE html>
<html style="height:100%;margin:0;padding:0;">
<title>Leaflet page with tiles from localhost</title>
<meta charset="utf-8">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style type="text/css">
.leaflet-tile-container { pointer-events: auto; }
</style>
</head>
<body style="height:100%;margin:0;padding:0;">
<div id="map" style="height:100%"></div>

<script>
    var map = L.map('map');
    L.tileLayer('http://192.168.3.32/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 21,
        maxNativeZoom: 20
    }).addTo(map);

    var hash = L.hash(map)

    let mqttSub = mqtt.connect('ws://pi-ucsk.local:15675');
    //let mqttSub = mqtt.connect('mtqq://localhost:15675')
    mqttSub.on('connect', function() {
        console.log("mqtt connected.");
        mqttSub.subscribe('gps');
    });

    var addMarker = null;
    var oldData = {};
    mqttSub.on('message', function(topic, message) {
        readGPSData(message.toString());
    });

    function readGPSData(data)
    {
        // console.log(data);
        if(data == null) return;
        jsonData = JSON.parse(data);

        if(jsonData.longitude == NaN || jsonData.latitude == NaN) return;

        if (map && addMarker){
            map.removeLayer(addMarker);
            // points list -> [latitude, longitude]
            L.polyline([[jsonData.latitude, jsonData.longitude], [oldData.latitude, oldData.longitude]], {"color": "green", "weight": 5, "opacity": 0.3}).addTo(map);
        }
        // show a marker on the map marker points -> [longitude, latitude]
        addMarker = L.marker({lon: jsonData.longitude, lat: jsonData.latitude}).bindPopup('Current position').addTo(map);

        // map center -> marker position.
        map.setView({lon: jsonData.longitude, lat: jsonData.latitude}, 18);

        oldData = jsonData;
    }
    //]]>
</script>

</body>
</html>
